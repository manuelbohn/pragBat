---
title: "Data Processing"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(knitr)
library(langcog)
library(ggthemes)
library(jsonlite)
library(readxl)
library(corrr)
library(corrplot)
library(ggcorrplot)
library(reshape2)
library(psych)
library(readODS)

```


```{r}
# importing data
### die flogenden Zeilen kannst du überspringen. Weiter gehts in Zeile 68
files <- dir("~/Work/PragBat/raw_data/")

raw_data <- data_frame()
for (f in files) {
  jf <- paste("~/Work/PragBat/raw_data/",f,sep="")
  jd <- jsonlite::fromJSON(paste(readLines(jf), collapse=""))
  date <- str_sub(jf,33,str_length(jf)-11)
  id <- as_data_frame(jd$data$data) %>% mutate(test_date = date, 
                                               trial = as.character(trial))
  raw_data <- bind_rows(raw_data, id)
}

unique(raw_data$subid)


task_data <- raw_data %>%
  filter(trial != "training", 
         trial != "filler1", 
         trial != "filler2",
         trial != "train",
         trial != "train2")%>%
  filter(phase == "shape" | is.na(phase))%>%
  mutate(subid = recode(subid, `13.2` = "Vp13.2",
                        `13.2` = "Vp13.2",
                        `14.2` = "Vp14.2",
                        `16.2` = "Vp16.2",
                        `19.1` = "Vp19.1",
                        `12.1` = "Vp12.1",
                        `29.2` = "Vp29.2",
                        `26.1` = "Vp26.2",
                        `37.1` = "Vp37.1",
                        `38.1` = "Vp38.1"
                        ))%>%
  select(subid, subage, test_date, task, trial, correct)%>%
  separate(subid, into = c("id","test_day"), sep="\\.")%>%
  mutate(test_day = ifelse(id == "Vp12" & test_date =="2019-11-26", 2, test_day))


#write_csv(task_data, "../data/data.csv")

task_data <- read_csv("../data/data.csv")

# damit du das daten file mit dem log file (deine Liste) mergen kannst (brauchen wir für das numerische alter) legst du deine liste in den gleichen ordner in dem auch ader repository ordner liegt. Dann sollte es klappen.

log <- read_ods("../../VP Liste.ods", sheet = 2)%>%
  mutate(age = as.numeric(difftime(test_day_1, `birthday `, units = "days"))/365.25,
         id = paste("Vp",`ID `, sep = ""))%>%
  select(id, age, status)
  

data <- task_data %>%
  left_join(log)%>%
  mutate(check_age = ifelse(subage == substr(age,1,1),T,F))


```

```{r}
data%>%
  group_by(subage)%>%
  summarise(n= length(unique(id)))

```

```{r}
data %>%
  group_by(subage,id)%>%
  summarise(testdays = length(unique(test_day)))%>%
  filter(testdays == 2)%>%
  summarise(complete_retest_data = length(id))
```



```{r}
data %>%
  group_by(id,test_day)%>%
  summarise(n())%>%
  arrange(id,test_day)
 
```


```{r}
data%>%
  group_by(test_day,task)%>%
  summarise(n= length(unique(id)))
```

```{r}
p1 <- data%>%
  group_by(id,subage,task)%>%
  filter(subage != "5",
         task != "training")%>%
  summarise(mean = mean(correct))


p2 <- p1 %>%
  group_by(subage,task)%>%
  multi_boot_standard(col = "mean")

ggplot()+
  geom_hline(yintercept = .5, lty = 2)+
  geom_line(data = p2,aes(x = subage, y = mean, group = task), alpha = .5)+
  geom_jitter(data = p1, aes(x = subage, y = mean, col = subage), alpha = .5, width = .2, height = .01)+
  geom_pointrange(data = p2, aes(x = subage, y = mean, ymin = ci_lower, ymax = ci_upper, col = subage))+
  facet_wrap(~task)+
  labs(x = "Age Group", y = "Proportion Correct")+
  scale_color_ptol(name = "Age")+
  theme_few()+
  theme(legend.position = c(.85,.2))
```


```{r}
p12 <- data%>%
  group_by(id,age,task)%>%
  filter(task != "training")%>%
  summarise(mean = mean(correct))


ggplot(data = p12, aes(x = age, y = mean))+
  geom_hline(yintercept = .5, lty = 2)+
  geom_jitter(alpha = .5, width = .2, height = .01)+
  geom_smooth(method = "glm")+
  facet_wrap(~task)+
  labs(x = "Age", y = "Proportion Correct")+
  scale_color_ptol(name = "Age")+
  theme_few()+
  theme(legend.position = c(.85,.2))
```


```{r}
p3 <- data%>%
  filter(task != "training")%>%
  group_by(id,task, test_day)%>%
  summarise(mean = mean(correct))%>%
  spread(test_day, mean)%>%
  rename("Day1" = `1`,
         "Day2" = `2`)%>%
  na.omit()

ggplot(p3, aes(x = Day1, y = Day2))+
  geom_jitter(width = .05, height = .05, alpha = .5)+
  geom_abline(intercept = 0, slope = 1, lty = 2, alpha = 0.7, size = 0.5)+
  geom_smooth(method = "lm", col = "#af6300", se = T)+
  facet_grid(~task)+
  coord_fixed()+
  xlim(-.1,1.1)+
  ylim(-.1,1.1)+
  theme_few()

```



```{r}
reli <- data%>%
  filter(task != "training")%>%
  group_by(id,task, test_day)%>%
  summarise(mean = mean(correct))%>%
  spread(test_day, mean)%>%
  na.omit()%>%
  rename("Day1" = `1`,
         "Day2" = `2`)%>%
  group_by(task)%>%
  summarize(reli = cor.test(Day1,Day2)$estimate,
            lci = cor.test(Day1,Day2)$conf.int[1],
            uci = cor.test(Day1,Day2)$conf.int[2],
            p = cor.test(Day1,Day2)$p.value)%>%
  mutate_if(is.numeric, round, digits = 2)


reli
```

```{r}
reli_age <- data%>%
  filter(task != "training")%>%
  group_by(subage, id,task, test_day)%>%
  summarise(mean = mean(correct))%>%
  spread(test_day, mean)%>%
  na.omit()%>%
  rename("Day1" = `1`,
         "Day2" = `2`)%>%
  group_by(subage,task)%>%
  summarize(reli = cor.test(Day1,Day2)$estimate,
            lci = cor.test(Day1,Day2)$conf.int[1],
            uci = cor.test(Day1,Day2)$conf.int[2],
            p = cor.test(Day1,Day2)$p.value)%>%
  mutate_if(is.numeric, round, digits = 2)


reli_age
```

```{r}
cor <- data%>%
  filter(task != "training")%>%
  group_by(id,task)%>%
  summarise(mean = mean(correct))%>%
  spread(task, mean)%>%
  ungroup()%>%
  select(-id)%>%
  corrr::correlate(diagonal = reli$reli)%>%
  gather(task, cor, -rowname)%>%
  mutate(cor = replace(cor, duplicated(cor), NA))%>%
  mutate_if(is.numeric, round, digits = 2)%>%
  na.omit()
  

ggplot(cor, aes(x = rowname, y = task, fill = cor))+
  geom_tile(color = "white")+
  labs(x = "", y = "")+
  scale_fill_gradient2(low = "#CC6677", high = "#117733", mid = "white", 
   midpoint = 0, limit = c(-1,1), space = "Lab", 
   name="Correlation") +
   coord_fixed()+
  theme_few(base_size = 12)+
  geom_text(aes(label = cor), color = "black", size = 3) +
  theme(legend.justification = c(1, 0),
        legend.position = c(0.55, 0.7),
        legend.direction = "horizontal",
        axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))+
  guides(fill = guide_colorbar(barwidth = 7, barheight = 1,
                title.position = "top", title.hjust = 0.5))
```

```{r}
library(psy)

fa_data <- p1 %>%
  spread(task, mean)%>%
  ungroup()%>%
  select(-id, -subage)%>%
  na.omit()
  

pca <- principal(fa_data,nfactors=2, rotate="varimax")

fit <- factanal(fa_data, 2, rotation="varimax")

scree.plot(fit$correlation)

fit$loadings

pca$loadings

plot(pca)

```


